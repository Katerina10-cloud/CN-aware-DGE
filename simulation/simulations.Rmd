---
title: "Simulate RNAseq counts"
output: html_document
date: "2024-05-07"
---

```{r}
setwd("/Users/katsiarynadavydzenka/Documents/PhD_AI/CN-aware-DGE/simulation")

library(tidyverse)
library(compcodeR)
```

## Using compcodeR simulator


```{r}
rna_counts_sim <- compcodeR::generateSyntheticData(dataset = "rna_counts_sim", n.vars = 15000, 
                                                   samples.per.cond = 36, 
                                                   n.diffexp = 0, 
                                                   repl.id = 1, seqdepth = 1e7, 
                                                   fraction.upregulated = 0.0, 
                                                   between.group.diffdisp = TRUE, 
                                                   filter.threshold.total = 1, 
                                                   filter.threshold.mediancpm = 0, 
                                                   fraction.non.overdispersed = 0, 
                                                   relmeans = "auto",
                                                   dispersions = "auto",
                                                   random.outlier.high.prob = 20,
                                                   random.outlier.low.prob = 20,
                                                   output.file = "rna_counts_sim.rds")

#rna_counts_sim <- rna_counts_sim@count.matrix
#rna_normal <- luad_rna_sd %>% as.data.frame() %>% select(1:45)
#rna_tumor <- luad_rna_sd %>% as.data.frame() %>% select(46:90)
#rna_counts <- cbind(brca_rna_normal, brca_rna_tum)
```

## Using DESeq2 simulator function

```{r}
library(DESeq2)

deseq_sim <- makeExampleDESeqDataSet(
  n = 15000,
  m = 72,
  betaSD = 0,
  interceptMean = 6,
  interceptSD = 2,
  dispMeanRel = function(x) 4/x + 0.1
  #sizeFactors = rep(1, m)
)
```
item{n}{number of rows}
item{m}{number of columns}
item{betaSD}{the standard deviation for non-intercept betas, i.e. beta ~ N(0,betaSD)}
item{interceptMean}{the mean of the intercept betas (log2 scale)}
item{interceptSD}{the standard deviation of the intercept betas (log2 scale)}
item{dispMeanRel}{a function specifying the relationship of the dispersions on code{2^trueIntercept}}
item{sizeFactors}{multiplicative factors for each sample}

Constructs a simulated dataset of Negative Binomial data from two conditions. By default, there are no fold changes between
the two conditions, but this can be adjusted with the \code{betaSD} argument.
```{r}
dds <- estimateSizeFactors(deseq_sim)
plotSparsity(dds)

dds <- estimateDispersions(dds)
plotDispEsts(dds)
```

```{r}
rna_counts <- deseq_sim@assays@data@listData[["counts"]]

# Generate metadata
metadata <- data.frame(patID = colnames(rna_counts),
                       condition = rep(c("A", "B"), each = 36))
metadata <- metadata %>% remove_rownames %>% column_to_rownames(var = "patID") 
```

## Using OmicsSIMLA

```{r}
rna_counts_sim1 <- read.table("rna_luad1.tsv", header = TRUE, sep = "")
rna_counts_sim2 <- read.table("rna_luad2.tsv", header = TRUE, sep = "")

rna_counts_sim2 <- rna_counts_sim2[,c(1:5000)]
rna_counts_sim2 <- rna_counts_sim2 %>% remove_rownames %>% column_to_rownames(var="FAM")
colnames(rna_counts_sim) <- paste0("S", 1:(ncol(rna_counts_sim)))
rownames(rna_counts_sim) <- paste("G", 1:(nrow(rna_counts_sim)))
```

##  Simulate CN data

```{r}
### Generate heterogeneous CN data ### 
cnv_0 <- sapply(1:36, function(x) sample(x=c(0.5,1,2,3), size = 500, replace=TRUE, prob = c(.50, .30, .10, .10)))
cnv_1 <- sapply(1:36, function(x) sample(x=c(0.5,1,2,3), size = 500, replace=TRUE, prob = c(.20, .60, .10, .10)))
cnv_2 <- sapply(1:36, function(x) sample(x=c(1,2,3,4), size = 11000, replace=TRUE, prob = c(.05, .70, .10, .10)))
```


```{r}
rna_normal <- rna_counts_sim[1:36]
rna_tumor <- rna_counts_sim[37:72]

cnv_luad <- cnv_luad[1:3000,]
cnv_tumor <- rbind(cnv_luad, cnv_0, cnv_1, cnv_2) %>% as.matrix()
cnv_norm <- matrix(2, nrow(rna_normal), 36)

colnames(cnv_norm) <- colnames(rna_normal)
rownames(cnv_norm) <- rownames(rna_normal)

cnv <- cbind(cnv_tumor, cnv_norm)
```


```{r}
## Prepare CN data ##
cnv <- apply(cnv, 1, function(x) x/2)
cnv <- apply(cnv, 1, function(x) x+10e-9)

rna_cnv <- rna_nocnv * cnv
```

